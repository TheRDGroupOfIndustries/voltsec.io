"use server";

import getSessionOrRedirect from "@/core/server/utils/getSessionOrRedirect";
import axios from 'axios';

let results:any = [];
const isValidUrl = (url: string): boolean => {
  try {
    new URL(url);
    return true;
  } catch (error) {
    return false;
  }
};

const scan = async (url:string, mode:string) => {
  let selectedMode = '';
  if (mode === "LightScan") {
    selectedMode = 'light'
  }
  if (mode === "BalancedScan") {
    selectedMode = 'balanced'
  }
  if (mode === "DeepScan") {
    selectedMode = 'deep'
  }
    try {
      const response = await axios.post("https://linguistic-olly-voltsec-c6a4acf0.koyeb.app/scanner", {
        "url": url,
        "mode": selectedMode
      })

      return response.data
    }
    catch {
      return {
        error: "Internal Server Error: An unexpected error occurred on the server. Please try again later.",
      };
    }

}
export const scanWebsiteAction = async ({
  url,
  mode,
}: {
  url: string;
  mode: string;
}) => {
  const session = await getSessionOrRedirect();
  if (!url || !mode) {
    return { error: "URL and mode are required" };
  }

  if (!isValidUrl(url)) {
    return { error: "Invalid URL format" };
  }

  try {
    const results = await scan(url, mode);
    return { error: null, data: results };
  } catch (_error) {
    return {
      error:
        "Internal Server Error: An unexpected error occurred on the server. Please try again later.",
    };
  }
};
