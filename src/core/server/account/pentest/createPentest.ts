"use server";

import { db } from "@/core/client/client";
import { $Enums, Pentest, Pentestsettings } from "@prisma/client";
import getSessionOrRedirect from "../../utils/getSessionOrRedirect";

export const createPentest = async (
  values: Pick<Pentest, "scope"> & {
    type?: $Enums.PentestType;
    settings: Pentestsettings;
  }
) => {
  const session = await getSessionOrRedirect();

  try {
    // check if charge are used pending
    // ...
    // create a pentest for a user and update the countofws
    await db.$transaction([
      db.pentest.create({
        data: {
          scope: values.scope,
          name: session.user.name,
          email: session.user.email,
          pentestType: values.type ?? "WEB",
          user: { connect: { id: session.user.id } },
          selectedBot: values.settings.selectedBot,
          selectedScanMode: values.settings.selectedScanMode,
        },
      }),
    ]);

    return { success: "Pentest Created Succesfully." };
  } catch (_error) {
    return { error: "Something went wrong." };
  }
};
